version: 0.2

phases:
  pre_build:
    commands:
      - echo "Installing Packer"
      - yum install -y ca-certificates
      - sh Packer/scripts/install-packer.sh
      - echo "Validating Packer template"
      - /tmp/packer validate Packer/template.pkr.hcl
  build:
    commands:
      - /tmp/packer build -color=false Packer/template.pkr.hcl
  post_build:
    commands:
      - ls
      - ls Packer/
      # Packer doesn't return non-zero status; we must do that if Packer build failed
      - test -s ami.json || exit 1
      - python Packer/scripts/parse_packer_output.py
      - cat ami.json
artifacts:
  files:
    - ami.json
  discard-paths: yes
