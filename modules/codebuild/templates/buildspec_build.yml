version: 0.2

env:
    variables:
        CODE_SRC_DIR: "."

phases:
    install:
        runtime-versions:
            python: 3.9
        commands:
            #- stat $${CODEBUILD_SRC_DIR_SourceAnsibleOutput}/init.sh && bash $${CODEBUILD_SRC_DIR_SourceAnsibleOutput}/init.sh $${CODEBUILD_SRC_DIR_SourceAnsibleOutput} || echo
            - sudo yum install -y ansible tree
            - yum install -y jq
            - curl -s -qL -o mitogen.tar.gz https://files.pythonhosted.org/packages/source/m/mitogen/mitogen-${mitogen_version}.tar.gz
            - mv mitogen.tar.gz /opt; cd /opt; tar vxzf mitogen.tar.gz
            - curl -s -qL -o packer.zip https://releases.hashicorp.com/packer/${packer_version}/packer_${packer_version}_linux_amd64.zip
            - unzip -o packer.zip
            - mv packer /bin
            - rm packer.zip
    build:
        commands:
            - echo "Configuring AWS credentials"
            - curl -qL -o aws_credentials.json http://169.254.170.2/$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI > aws_credentials.json
            - aws configure set region $AWS_REGION
            - aws configure set aws_access_key_id `jq -r '.AccessKeyId' aws_credentials.json`
            - aws configure set aws_secret_access_key `jq -r '.SecretAccessKey' aws_credentials.json`
            - aws configure set aws_session_token `jq -r '.Token' aws_credentials.json`
            - echo "Building HashiCorp Packer template, ${packer_config}"
            - cd $${CODEBUILD_SRC_DIR}/$${CODE_SRC_DIR}
            - rm -rf /etc/ansible/roles || echo "Ansible Roles Directory Does Not Exist... Okay"
            - ln -s $${CODEBUILD_SRC_DIR_SourceAnsibleOutput}/roles /etc/ansible/roles 
            - /bin/packer init ${packer_config}
            - /bin/packer build -var ansible_roles=$${CODEBUILD_SRC_DIR_SourceAnsibleOutput}/roles ${packer_config}

artifacts:
    files:
        - '**/*'